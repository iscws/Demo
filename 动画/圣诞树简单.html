<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Christmas Tree</title>
    <style>
      canvas {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: #fefdfd;
        box-shadow: 0 0 2px rgba(0, 0, 0, 0.4);
      }
    </style>
  </head>
  <body>
    <canvas id="tree"></canvas>
    <script>
      const CANVAS_WIDTH = 360;
      const CANVAS_HEIGHT = 620;
      // ä½¿ç”¨ä¸€ä¸ªæ•°ç»„ä¿å­˜ç»˜åˆ¶æ ‘çš„åƒç´ ç‚¹
      const branchPixels = [];
      const gifts = ["ğŸ", "ğŸ", "ğŸ­", "ğŸ¬", "ğŸˆ", "ğŸ§¸", "ğŸ””"];
      const image = new Image(500, 500);
      //   image.src = "star.png";

      function initCanvas(id) {
        const canvas = document.getElementById(id);
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;
        return canvas;
      }

      function main() {
        const canvas = initCanvas("tree");

        // æ ‘çš„èµ·å§‹ä½ç½®
        const location = [CANVAS_WIDTH * 0.5, CANVAS_HEIGHT];

        drawBranches(canvas, location, 0, 100, 20);
        drawLeaves(canvas);
        drawGifts(canvas);
      }

      function drawBranches(canvas, start, angle, branchHeight, branchWidth) {
        const ctx = canvas.getContext("2d");
        ctx.save();
        ctx.beginPath();
        // å°†ç”»å¸ƒåŸç‚¹ç§»åŠ¨åˆ°èµ·å§‹ä½ç½®
        ctx.translate(...start);
        // è®¾ç½®ç»˜åˆ¶é¢œè‰²
        ctx.strokeStyle = "#333";
        // è®¾ç½®ç»˜åˆ¶å®½åº¦
        ctx.lineWidth = branchWidth;
        // è®¾ç½®æ—‹è½¬è§’åº¦
        ctx.rotate((angle * Math.PI) / 180);

        ctx.moveTo(0, 0);
        ctx.lineTo(0, -branchHeight);
        ctx.stroke();

        if (branchHeight > 6) {
          // ç»˜åˆ¶å³å­æ ‘
          drawBranches(
            canvas,
            [0, -branchHeight],
            35,
            branchHeight * 0.5,
            branchWidth * 0.7
          );
          // ç»˜åˆ¶å·¦å­æ ‘
          drawBranches(
            canvas,
            [0, -branchHeight],
            -35,
            branchHeight * 0.5,
            branchWidth * 0.7
          );
          // ç»˜åˆ¶ä¸­é—´çš„æ ‘å¹²
          drawBranches(
            canvas,
            [0, -branchHeight],
            0,
            branchHeight * 0.8,
            branchWidth * 0.7
          );
        }

        ctx.restore();
      }

      function drawLeaves(canvas) {
        const ctx = canvas.getContext("2d");
        // è·å–ç”»å¸ƒåƒç´ æ•°æ®
        const imageData = ctx.getImageData(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        const data = imageData.data;

        for (let y = 0; y < CANVAS_HEIGHT; y++) {
          for (let x = 0; x < CANVAS_WIDTH; x++) {
            // è·å–åƒç´ ç‚¹ alpha é€šé“å€¼
            const alpha = data[4 * (y * CANVAS_WIDTH + x) + 3];

            // å¦‚æœ alpha å€¼å¤§äº 0 è¯´æ˜è¿™ä¸ªä½ç½®æœ‰å›¾åƒï¼›æ’é™¤åŸºç¡€æ ‘å¹²çš„åƒç´ ç‚¹ï¼›
            if (alpha > 0 && y < CANVAS_HEIGHT - 100) {
              branchPixels.push([x, y]);
            }
          }
        }

        for (let i = 0; i < branchPixels.length; i++) {
          // å‡å°‘ç»˜åˆ¶å‡ ç‡
          if (Math.random() < 0.3) {
            const loc = branchPixels[i];
            loc[0] += (Math.random() - 0.5) * 5;
            loc[1] += (Math.random() - 0.5) * 5;
            // è®¾ç½®ç»˜åˆ¶é¢œè‰²ï¼Œè¶Šå¾€å¤–é¢œè‰²è¶Šæµ…
            const green = (255 * (CANVAS_HEIGHT - loc[1])) / CANVAS_HEIGHT;

            ctx.save();
            ctx.beginPath();
            ctx.translate(...loc);
            ctx.rotate(Math.random() * Math.PI * 2);
            ctx.fillStyle = `rgba(0, ${green}, 0, .2)`;
            // ç»˜åˆ¶åŠåœ†
            ctx.arc(0, 0, 5, 0, Math.PI);
            ctx.fill();
            ctx.restore();
          }
        }
      }

      function drawGifts(canvas) {
        const ctx = canvas.getContext("2d");

        ctx.save();
        ctx.font = "1.5rem sans-serif";
        for (let i = 0; i < 30; i++) {
          // ä»æ ‘çš„åƒç´ ç‚¹æ•°ç»„ä¸­éšæœºè·å–ä½ç½®
          const location =
            branchPixels[Math.floor(Math.random() * branchPixels.length)];
          const gift = gifts[i % gifts.length];

          ctx.fillText(gift, ...location);
        }
        ctx.restore();
      }

      //   function drawStar(canvas) {
      //     const size = 50;
      //     const ctx = canvas.getContext("2d");
      //     const loc = [CANVAS_WIDTH * 0.5 - size / 2, 80];

      //     // ç»˜åˆ¶å›¾ç‰‡
      //     ctx.drawImage(image, ...loc, size, size);
      //   }

      window.addEventListener("load", main);
    </script>
  </body>
</html>
